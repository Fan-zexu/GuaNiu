# monorepo

Monorepoæ˜¯ä¸€ç§é¡¹ç›®ç®¡ç†æ–¹å¼ï¼Œåœ¨å®ƒä¹‹å‰ï¼Œç®¡ç†æ–¹å¼æ˜¯MultiRepoï¼Œå³æ¯ä¸ªé¡¹ç›®å¯¹åº”ä¸€ä¸ªä»“åº“ã€‚è¿™ä¼šå¯¼è‡´ä¸€äº›å¼Šç«¯ï¼Œæ¯”å¦‚ä»£ç ç®¡ç†åˆ†æ•£ã€ç›¸åŒåŠŸèƒ½åœ¨æ¯ä¸ªä»“åº“é‡å¤ç»´æŠ¤ç­‰é—®é¢˜ã€‚

Monorepo å¿…å¤‡3å¤§èƒ½åŠ›ï¼š

- ä¾èµ–ç®¡ç†èƒ½åŠ›
- ä»»åŠ¡ç¼–æ’èƒ½åŠ›
- ç‰ˆæœ¬å‘å¸ƒèƒ½åŠ›


å¸¸è§Monorepoå·¥å…·æœ‰ï¼š

| å·¥å…·      | ä¾èµ–ç®¡ç†èƒ½åŠ› | ä»»åŠ¡ç¼–æ’èƒ½åŠ› | ç‰ˆæœ¬å‘å¸ƒèƒ½åŠ› |
| ----------- | ----------- | ----------- | ----------- |
| Pnpm Workspace | âœ…  |  âœ… | âŒ |
| Rush   | âœ…  | âœ… | âœ… |
| Lage   | âŒ | âœ… | âŒ |
| Lerna   | âŒ | âœ… | âœ… |
| Turborepo | âŒ | âœ… | âŒ |

- [Pnpn](https://pnpm.io/) Pnpmé™¤äº†å…·å¤‡é«˜æ€§èƒ½çš„ä¾èµ–ç®¡ç†èƒ½åŠ›ä¹‹å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡ `--filter`å‚æ•°æ”¯æŒä¸€å®šä»»åŠ¡ç¼–æ’ï¼Œæ‰€ä»¥ä¹Ÿå°†å…¶åˆ—å…¥ã€‚
- [Rush](https://rushjs.io/) ç”±å¾®è½¯å¼€æºçš„å¯æ‰©å±• Monorepo ç®¡ç†æ–¹æ¡ˆï¼Œå†…ç½® PNPM ä»¥åŠç±» Changesets å‘åŒ…æ–¹æ¡ˆï¼Œå…¶æ’ä»¶æœºåˆ¶æ˜¯ä¸€å¤§äº®ç‚¹ï¼Œä½¿å¾—åˆ©ç”¨ Rush å†…ç½®èƒ½åŠ›å®ç°è‡ªå®šä¹‰åŠŸèƒ½å˜å¾—æä¸ºæ–¹ä¾¿
- [Lage](https://microsoft.github.io/lage/) åŒæ ·æ˜¯å¾®è½¯å¼€æºï¼Œå¯ä»¥ç®—æ˜¯`Turbo`å‰èº«ï¼ŒåŒæ ·æ˜¯Goè¯­è¨€å®ç°ï¼Œä½†ç›¸è¾ƒäº`Turbo`äººæ°”å·®äº†ä¸€ä¸ªçº§åˆ«ã€‚
- [Lerna](https://lerna.js.org/) æ¯”è¾ƒæˆç†Ÿï¼Œä¸­è§„ä¸­çŸ©menorepoæ–¹æ¡ˆï¼Œç›®å‰å·²ç»åœæ­¢ç»´æŠ¤ã€‚

ä¾èµ–ç®¡ç†è¿‡äºåº•å±‚ï¼Œç‰ˆæœ¬æ§åˆ¶è¾ƒä¸ºç®€å•ä¸”å·²æˆç†Ÿï¼Œå°†è¿™ä¸¤é¡¹èƒ½åŠ›å†åšçªç ´æ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼Œå®è·µä¸­åŸºæœ¬éƒ½æ˜¯ç»“åˆ `Pnpm` ä»¥åŠ `Changesets` è¡¥å…¨æ•´ä½“èƒ½åŠ›ï¼Œç”šè‡³å°±å¹²è„†ä¸“ç²¾äºä¸€ç‚¹ï¼Œå³ä»»åŠ¡ç¼–æ’ï¼Œä¹Ÿå°±æ˜¯ Turborepo çš„å‘åŠ›ç‚¹ã€‚


# Turborepo

## æ˜¯ä»€ä¹ˆ

Turborepo æ˜¯ä¸€ä¸ªé€‚ç”¨äº JavaScript å’Œ Typescript monorepo çš„é«˜æ€§èƒ½æ„å»ºå·¥å…·ï¼Œå®ƒä¸æ˜¯ä¸€ä¸ªä¾µå…¥å¼çš„å·¥å…·ï¼Œä½ å¯ä»¥åœ¨é¡¹ç›®ä¸­æ¸è¿›çš„å¼•å…¥å’Œä½¿ç”¨å®ƒï¼Œå®ƒé€šè¿‡è¶³å¤Ÿçš„å°è£…åº¦ï¼Œä½¿ç”¨ä¸€äº›ç®€å•çš„é…ç½®æ¥è¾¾åˆ°é«˜æ€§èƒ½çš„é¡¹ç›®æ„å»ºã€‚
å’Œesbuildä¸€æ ·ï¼ŒTurborepoä¹Ÿæ˜¯åŸºäºgoå®ç°çš„å·¥å…·ï¼Œåœ¨è¯­è¨€å±‚é¢ä¸Šå°±å…·æœ‰ä¸€å®šçš„æ€§èƒ½ä¼˜åŠ¿ã€‚

è¿™é‡Œå¤§å®¶å¯ä»¥äº†è§£ä¸‹å®ƒçš„å…„å¼Ÿäº§å“**Turbopack**ï¼Œå·ç§°æ¯”`vite`è¿˜å¿«10å€çš„æ„å»ºå·¥å…·ğŸ‚ğŸº

`Turborepo`å’Œ`Turbopack`ä¸¤æ¬¾äº§å“ï¼Œåº•å±‚ä¾èµ–`Turbo`

## ä¼˜åŠ¿

### å¤šä»»åŠ¡å¹¶è¡Œå¤„ç†

åœ¨æˆ‘ä»¬å¯¹å¤šä¸ªå­åŒ…æ‰§è¡Œæ„å»ºæ—¶ï¼Œ`Turbo`ä¼šå¹¶è¡Œæ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§æé«˜æ„å»ºé€Ÿåº¦ã€‚

å¯¹æ¯”ä¼ ç»Ÿçš„`lerna`æˆ–è€…`yarn`ï¼Œå®ƒä»¬å†…éƒ¨éƒ½æä¾›äº†ç±»ä¼¼`workspace run`è¿™æ ·çš„å‘½ä»¤ã€‚æ¯ä¸ªå­é¡¹ç›®çš„`script`è„šæœ¬ï¼Œéƒ½ä»¥**æ‹“æ‰‘**æ–¹å¼è¢«è¿è¡Œã€‚

ä»€ä¹ˆæ˜¯**æ‹“æ‰‘**

> æ‹“æ‰‘ æ˜¯ä¸€ç§æ’åº æ‹“æ‰‘æ’åºæ˜¯ä¾èµ–ä¼˜å…ˆçš„æœ¯è¯­ï¼Œ å¦‚æœ A ä¾èµ–äº Bï¼ŒB ä¾èµ–äº Cï¼Œåˆ™æ‹“æ‰‘é¡ºåºä¸º Cã€Bã€Aã€‚
> æ¯”å¦‚ä¸€ä¸ªè¾ƒå¤§çš„å·¥ç¨‹å¾€å¾€è¢«åˆ’åˆ†æˆè®¸å¤šå­å·¥ç¨‹ï¼Œæœ‰äº›å­å·¥ç¨‹å¿…é¡»åœ¨å…¶å®ƒæœ‰å…³å­å·¥ç¨‹å®Œæˆä¹‹åæ‰èƒ½å¼€å§‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªå­å·¥ç¨‹çš„å¼€å§‹æ˜¯ä»¥å®ƒçš„æ‰€æœ‰å‰åºå­å·¥ç¨‹çš„ç»“æŸä¸ºå…ˆå†³æ¡ä»¶çš„

ä¸‹é¢å¯¹æ¯”å›¾ï¼Œæ¥çœ‹`Turbo`å’Œ`lerna`å¤„ç†ä»»åŠ¡çš„æ–¹å¼

å­åŒ…å…³ç³»ï¼š

![ä»»åŠ¡å…³ç³»](./images/your-monorepo-excalidraw.webp)

`lerna`æ‰§è¡Œä»»åŠ¡ï¼š

![lernaæ‰§è¡Œä»»åŠ¡](./images/yarn-workspaces-excalidraw.webp)

`Turbo`æ‰§è¡Œä»»åŠ¡ï¼š

![turboæ‰§è¡Œ](./images/turborepo-excalidraw.webp)

å¾ˆæ˜æ˜¾ï¼Œ`Turbo`å¯ä»¥å¹¶è¡Œæ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œè€Œ`lerna`åªèƒ½ä¸²è¡Œæ‰§è¡Œã€‚æ€§èƒ½ä¸è¨€è€Œå–»

### å¢é‡æ„å»º

`Turbo`ä¸­ä¾èµ–ç¼“å­˜æœºåˆ¶(ä¼šè®°å½•æ„å»ºå†…å®¹ï¼Œå¹¶è·³è¿‡å·²ç»è®¡ç®—è¿‡çš„å†…å®¹)ï¼Œå®ç°å¢é‡æ„å»ºï¼Œæå‡æ„å»ºæ•ˆç‡ã€‚

### äº‘ç¼“å­˜

`Turbo`é€šè¿‡å…¶è¿œç¨‹ç¼“å­˜åŠŸèƒ½å¯ä»¥å¸®åŠ©å¤šäººè¿œç¨‹æ„å»ºäº‘ç¼“å­˜å®ç°äº†æ›´å¿«çš„æ„å»ºã€‚

### ä»»åŠ¡ç®¡é“

å¯ä»¥ç”¨é…ç½®æ–‡ä»¶å®šä¹‰ä»»åŠ¡é—´çš„å…³ç³»ï¼Œç„¶åè®©`Turbo`ä¼˜åŒ–æ„å»ºå†…å®¹å’Œæ—¶é—´

### çº¦å®šé…ç½®

é€šè¿‡çº¦å®šé™ä½å¤æ‚æ€§ï¼Œåªéœ€å‡ è¡Œ`JSON`å³å¯é…ç½®æ•´ä¸ªé¡¹ç›®ä¾èµ–ï¼Œæ‰§è¡Œè„šæœ¬çš„é¡ºåº

### æµè§ˆå™¨ä¸­çš„é…ç½®æ–‡ä»¶

ç”Ÿæˆæ„å»ºé…ç½®æ–‡ä»¶ï¼Œå¯ä»¥åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹ä»»åŠ¡çš„èŠ±è´¹æ—¶é•¿ã€‚

## Turboæ ¸å¿ƒæ¦‚å¿µ

### ç®¡é“ pipeline

- é€šè¿‡`pipeline json`å¯ä»¥æ˜¾å¼æŒ‡å®šä»»åŠ¡å…³ç³»
- `pipeline`ä¸­çš„æ¯ä¸€ä¸ª`key`ï¼Œéƒ½æŒ‡å‘`package.json`ä¸­çš„`script`è„šæœ¬ï¼Œå¹¶ä¸”éƒ½å¯ä»¥è¢«`turbo run `æ‰€è¿è¡Œ
- `turbo`æœ€ç»ˆä¼šæ ¹æ®è¿™åˆ†é…è‡³ï¼Œå¯¹æ¯ä¸ªå­packageæœ‰åºæ‰§è¡Œè„šæœ¬å’Œä¼˜åŒ–ç¼“å­˜è¾“å‡º

```js

// turbo.json
{
  "$schema": "https://turborepo.org/schema.json",
  "pipeline": {
    "build": {
      // A package's `build` script depends on that package's
      // dependencies' and devDependencies'
      // `build` tasks  being completed first
      // (the `^` symbol signifies `upstream`).
      "dependsOn": ["^build"],
      // note: output globs are relative to each package's `package.json`
      // (and not the monorepo root)
      "outputs": [".next/**"]
    },
    "test": {
      // A package's `test` script depends on that package's
      // own `build` script being completed first.
      "dependsOn": ["build"],
      "outputs": [],
      // A package's `test` script should only be rerun when
      // either a `.tsx` or `.ts` file has changed in `src` or `test` folders.
      "inputs": ["src/**/*.tsx", "src/**/*.ts", "test/**/*.ts", "test/**/*.tsx"]
    },
    "lint": {
      // A package's `lint` script has no dependencies and
      // can be run whenever. It also has no filesystem outputs.
      "outputs": []
    },
    "deploy": {
      // A package's `deploy` script depends on the `build`,
      // `test`, and `lint` scripts of the same package
      // being completed. It also has no filesystem outputs.
      "dependsOn": ["build", "test", "lint"],
      "outputs": []
    }
  }
}

```

#### DependsOnä¾èµ–

å‡è®¾ä½ çš„åº”ç”¨ä¸­çš„3ä¸ªåŒ…ï¼Œæœ‰å¦‚ä¸‹ä¾èµ–å…³ç³»ï¼Œ`apps/web`å’Œ`apps/docs`ä¾èµ–`packages/shared`çš„æ„å»ºäº§ç‰©

![ä¾èµ–å›¾](./images/your-monorepo-excalidraw.webp)

```js
  "pipeline": {
    "build": {
      "dependsOn": ["^build"]
    }
  }
```

#### å¸¸è§„ä¾èµ–

å¦‚æœä¸€ä¸ªä»»åŠ¡çš„æ‰§è¡Œï¼Œåªä¾èµ–è‡ªå·±åŒ…çš„å…¶ä»–ä»»åŠ¡ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨å¸¸è§„ä¾èµ–

```js
  "pipeline": {
    "deploy": {
      "dependsOn": ["build", "test", "lint"]
    }
  }
```

#### æ‹“æ‰‘ä¾èµ–

å¦‚æœä¸€ä¸ªä»»åŠ¡çš„æ‰§è¡Œï¼Œä¾èµ–è‡ªå·±åŒ…çš„å…¶ä»–ä»»åŠ¡ï¼Œä¹Ÿä¾èµ–å…¶ä»–åŒ…çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨æ‹“æ‰‘ä¾èµ–

```js
  "pipeline": {
    "build": {
      "dependsOn": ["^build"]
    }
  }
```

ç‰¹åˆ«æ³¨æ„ï¼š`dependsOn`è¡¨ç¤ºå½“å‰å‘½ä»¤æ‰€ä¾èµ–çš„å‘½ä»¤ï¼Œ`^`è¡¨ç¤º`devDependencies`å’Œ`dependencies`ä¸­çš„æ‰€æœ‰ä¾èµ–éƒ½æ‰§è¡Œå®Œ`build`ä¹‹åï¼Œæ‰ä¼šæ‰§è¡Œ`build`

#### ç©ºä¾èµ–

å¦‚æœä¸€ä¸ªä»»åŠ¡çš„æ‰§è¡Œï¼Œä¸ä¾èµ–ä»»ä½•å…¶ä»–ä»»åŠ¡ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ç©ºä¾èµ–ã€‚æ­¤æ—¶è¿™ä¸ªä»»åŠ¡å¯ä»¥åœ¨ä»»ä½•æ—¶é—´è¢«æ‰§è¡Œã€‚

```js
  "pipeline": {
    "lint": {
      "dependsOn": []
    }
  }
```

#### outputs

`outpus`è¡¨ç¤ºå‘½ä»¤æ‰§è¡Œè¾“å‡ºçš„æ–‡ä»¶ç¼“å­˜ç›®å½•ï¼Œé»˜è®¤å€¼ `["dist/**", "build/**"]`

#### cache

`cache`è¡¨ç¤ºæ˜¯å¦ç¼“å­˜ï¼Œé€šå¸¸åœ¨æ‰§è¡Œ`dev`å‘½ä»¤æ—¶ï¼Œä¸éœ€è¦ç¼“å­˜ã€‚

```js
{
  "$schema": "https://turborepo.org/schema.json",
  "pipeline": {
    "dev": {
      "cache": false
    }
  }
}

```

#### input

è¡¨ç¤ºå‘½ä»¤æ‰§è¡Œæ‰€ä¾èµ–çš„æ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆå‘½ä»¤ä¼šè¢«é‡æ–°æ‰§è¡Œã€‚

ä¾‹å¦‚ï¼Œå¯ä»¥ç”¨å®ƒæ¥å¸®åŠ©ä½ è·³è¿‡å•å…ƒæµ‹è¯•ï¼Œé™¤éæºæ–‡ä»¶å‘ç”Ÿæ›´æ”¹ã€‚

é»˜è®¤ä¸º`[]`ï¼Œè¡¨ç¤ºä»»ä½•æ–‡ä»¶å˜åŒ–éƒ½ä¼šè§¦å‘å‘½ä»¤æ‰§è¡Œã€‚

```js
{
  "$schema": "https://turborepo.org/schema.json",
  "pipeline": {
    "test": {
      "inputs": ["src/**/*.tsx", "src/**/*.ts", "test/**/*.ts", "test/**/*.tsx"]
    }
  }
}

```

#### outputMode

è¡¨ç¤ºè¾“å‡ºæ¨¡å¼ï¼ŒåŒ…å«ï¼š

- `full`(é»˜è®¤å€¼) ï¼Œæ˜¾ç¤ºä»»åŠ¡çš„æ•´ä¸ªè¾“å‡º

- `new-only`ï¼Œæ˜¾ç¤ºç¼“å­˜æœªå‘½ä¸­çš„å®Œæ•´è¾“å‡ºå’Œç¼“å­˜å‘½ä¸­çš„è®¡ç®—å“ˆå¸Œå€¼ã€‚æ„æ€å°±æ˜¯è¿”å›å¸¦æœ‰hashçš„æ—¥å¿—å¹¶ä¸”å½“å¦‚æœæœ‰æœªå‘½ä¸­çš„å­åŒ…ç¼“å­˜æˆ–è€…æ‰“åŒ…é”™è¯¯å¯¼è‡´ç¼“å­˜æœªå‘½ä¸­å†æ¬¡æ‰“åŒ…æ—¶ä¼šè¾“å‡ºä¸Šä¸€æ¬¡ç¼“å­˜æœªå‘½ä¸­çš„çš„å­åŒ…å®Œæ•´ä»»åŠ¡è¾“å‡ºæ—¥å¿—

- `hash-only`ï¼Œä»…æ˜¾ç¤ºè®¡ç®—çš„ä»»åŠ¡å“ˆå¸Œ

- `none`ï¼Œéšè—ä»»åŠ¡è¾“å‡ºï¼Œå³ä¸ä¼šæ‰“å°æ‹“æ‰‘é¡ºåºå’Œæ‰“åŒ…è¾“å‡ºæ—¥å¿—

### å‘½ä»¤è¡Œä½¿ç”¨

#### å…¨å±€å‚æ•°

##### `--continue`

`true`ï¼š`turbo`å°†ä»¥æ‰§è¡ŒæœŸé—´é‡åˆ°çš„æœ€é«˜é€€å‡ºä»£ç å€¼é€€å‡ºã€‚

é»˜è®¤`false`

```
turbo run build --continue
```

##### `--parallel`

è„šæœ¬ç¨‹åºå¹¶è¡Œè¿è¡Œå‘½ä»¤å¹¶å¿½ç•¥ä¾èµ–å…³ç³»å›¾ã€‚è¿™å¯¹äºä½¿ç”¨å®æ—¶é‡æ–°åŠ è½½è¿›è¡Œå¼€å‘å¾ˆæœ‰ç”¨ã€‚ä¾‹å¦‚æˆ‘ä»¬å¯åŠ¨viteé¡¹ç›®çš„æ—¶å€™æˆ‘ä»¬å°±éœ€è¦å¿½ç•¥å…¶ä»–å¯èƒ½å‡ºç°çš„dependsOnä¾èµ–å…³ç³»

é»˜è®¤`false`

```json
"pipeline": {
  "build": {
    "dependsOn": ["^build"],
    "outputs": ["dist/**", "build/**"],
    "outputMode": "new-only"
  },
  "lint": {
    "outputs": []
  },
  "dev": {
    "cache": false,
    //
    "dependsOn": ["^build"]
  }
}
```

ç”±äºæˆ‘ä»¬åœ¨pipelineä¸­è®¾ç½®äº†dependsonçš„buildå‘½ä»¤ä¾èµ–ä¼˜å…ˆçš„é—®é¢˜æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŒ‡å®š--parallelå¹¶è¡Œæ‰§è¡Œå¹¶ä¸”é˜»æ­¢é»˜è®¤ä¾èµ– build æŒ‡ä»¤

```
turbo run lint --parallel --no-cache
turbo run dev --parallel --no-cache
```

##### `--filter`


##### `--force`


##### `--no-cache`


##### `--only`


## å®æˆ˜éƒ¨åˆ†

å°†å·²æœ‰`lerna yarn`æ”¹æˆ`turborepo`